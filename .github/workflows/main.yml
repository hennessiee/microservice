name: Connect VPN
on: push

jobs:
  build_account_service:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      - name: setup jdk 17
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: 17
      - name: Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-
      - name: Build Account Service
        run: |
          cd account-service
          ./gradlew clean
          ./gradlew build --no-daemon

      - name: Upload Account Service Artifact
        uses: actions/upload-artifact@v3
        with:
          name: account-service-jar
          path: account-service/build/libs/account-service-0.0.1-SNAPSHOT.jar

  build_inventory_service:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
      - name: Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-
      - name: Build Inventory Service
        run: |
          cd inventory-service
          ./gradlew clean build
      - name: Upload Inventory Service Artifact
        uses: actions/upload-artifact@v3
        with:
          name: inventory-service-jar
          path: inventory-service/build/libs/inventory-service-0.0.1-SNAPSHOT.jar

  build_facility_service:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
      - name: Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-
      - name: Build Facility Service
        run: |
          cd facility-service
          ./gradlew clean build
      - name: Upload Facility Service Artifact
        uses: actions/upload-artifact@v3
        with:
          name: facility-service-jar
          path: facility-service/build/libs/facility-service-0.0.1-SNAPSHOT.jar
  Setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache OpenConnect .deb Package
        uses: actions/cache@v4
        id: cache-openconnect
        with:
          path: ./packages
          key: ${{ runner.os }}-openconnect-${{ hashFiles('package-list.txt') }}
          restore-keys: |
            ${{ runner.os }}-openconnect-
      - name: Download OpenConnect Package
        if: steps.cache-openconnect.outputs.cache-hit != 'true'
        run: |
          mkdir -p ./packages
          apt-get download openconnect
          mv openconnect_*.deb ./packages/
        shell: bash

      - name: Install OpenConnect from Cached Package
        run: |
          sudo dpkg -i ./packages/openconnect_*.deb || sudo apt-get install -f -y
          sudo /sbin/modprobe tun
        shell: bash

      - name: Install AnyConnect VPN & Login
        env:
          VPN_USERNAME: ${{ secrets.USERNAME }}
          VPN_PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          printf 'Netlab Fontys ICT\n%s\n%s\n' "$VPN_USERNAME" "$VPN_PASSWORD" | sudo openconnect vpn.netlab.fontysict.nl -b
        shell: bash

      - name: Verify VPN Connection
        run: |
          ifconfig
          ping -c 4 ${{ secrets.IP_ADDRESS }}
        shell: bash

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keygen -lf ~/.ssh/id_rsa
          ssh-keyscan ${{ secrets.IP_ADDRESS }} >> ~/.ssh/known_hosts
        shell: bash
        
   #   - name: Check VM status
   #     run: |
   #      sshpass -p "${{ secrets.SSH_PASS }}" ssh -o StrictHostKeyChecking=no worker@${{ secrets.IP_ADDRESS }} "ping -c 4 192.168.141.128"
   #    shell: bash

      - name: Upload Manifests
        run: |
          sshpass -p "${{ secrets.SSH_PASS }}" scp -r ./k8s-config worker@${{ secrets.IP_ADDRESS }}:/home/worker/k8s-config
          
      - name: Apply Kubernetes config on VM
        run: |
          sshpass -p "${{ secrets.SSH_PASS }}" ssh -o StrictHostKeyChecking=no worker@${{ secrets.IP_ADDRESS }} "
                      echo '${{ secrets.SSH_PASS }}' | sudo -S su -c 'export KUBECONFIG=/etc/rancher/rke2/rke2.yaml && kubectl apply -f /home/worker/k8s-config'"
    #initialy do this:
    #            echo '${{ secrets.SSH_PASS }}' | sudo -S su -c 'export KUBECONFIG=/etc/rancher/rke2/rke2.yaml && kubectl create clusterrolebinding worker-admin-binding --clusterrole=cluster-admin --user=worker' &&

      - name: Check pod status
        run: |
          sshpass -p "${{ secrets.SSH_PASS }}" ssh -o StrictHostKeyChecking=no worker@${{ secrets.IP_ADDRESS }} "
                      echo '${{ secrets.SSH_PASS }}' | sudo -S su -c 'export KUBECONFIG=/etc/rancher/rke2/rke2.yaml && kubectl get pods'"
          
      - name: Disconnect VPN
        if: always()
        run: |
          sudo pkill openconnect || true
        shell: bash
